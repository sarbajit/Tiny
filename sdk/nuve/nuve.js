/*
*/
/*
 MIT
*/
var Url=require("url"),spawn=require("child_process").spawn,fs=require("fs"),XMLHttpRequest=function(o){var b=this,r=require("http"),s=require("https"),l,c,d={},p;"object"===typeof o&&null!==o&&"boolean"===typeof o.rejectUnauthorized&&(p=o.rejectUnauthorized);var q={"User-Agent":"node.js",Accept:"*/*"},g=!1,m=!1,n=q;this.UNSENT=0;this.OPENED=1;this.HEADERS_RECEIVED=2;this.LOADING=3;this.DONE=4;this.readyState=this.UNSENT;this.onreadystatechange=null;this.responseXML=this.responseText="";this.statusText=
this.status=null;this.open=function(a,b,e,c,f){d={method:a,url:b.toString(),async:typeof e!=="boolean"?true:e,user:c||null,password:f||null};this.abort();k(this.OPENED)};this.setRequestHeader=function(a,b){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";if(g)throw"INVALID_STATE_ERR: send flag is true";n[a]=b};this.getResponseHeader=function(a){return this.readyState>this.OPENED&&c.headers[a]&&!m?c.headers[a]:null};this.getAllResponseHeaders=
function(){if(this.readyState<this.HEADERS_RECEIVED||m)return"";var a="",b;for(b in c.headers)a=a+(b+": "+c.headers[b]+"\r\n");return a.substr(0,a.length-2)};this.send=function(a){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: connection must be opened before send() is called";if(g)throw"INVALID_STATE_ERR: send has already been called";var i=false,e=Url.parse(d.url);switch(e.protocol){case "https:":i=true;case "http:":var j=e.hostname;break;case void 0:case "":j="localhost";break;default:throw"Protocol not supported.";
}var f=e.port||(i?443:80),e=e.pathname+(e.search?e.search:"");this.setRequestHeader("Host",j);if(d.user){if(typeof d.password=="undefined")d.password="";var h=new Buffer(d.user+":"+d.password);n.Authorization="Basic "+h.toString("base64")}if(d.method=="GET"||d.method=="HEAD")a=null;else if(a){this.setRequestHeader("Content-Length",Buffer.byteLength(a));n["Content-Type"]||this.setRequestHeader("Content-Type","text/plain;charset=UTF-8")}j={host:j,port:f,path:e,method:d.method,headers:n};if(i&&p!==void 0)j.rejectUnauthorized=
p;m=false;if(!d.hasOwnProperty("async")||d.async){i=i?s.request:r.request;g=true;if(typeof b.onreadystatechange==="function")b.onreadystatechange();l=i(j,function(a){c=a;c.setEncoding("utf8");k(b.HEADERS_RECEIVED);b.status=c.statusCode;c.on("data",function(a){if(a)b.responseText=b.responseText+a;g&&k(b.LOADING)});c.on("end",function(){if(g){k(b.DONE);g=false}});c.on("error",function(a){b.handleError(a)})}).on("error",function(a){b.handleError(a)});a&&l.write(a);l.end()}else{f=".node-xmlhttprequest-sync-"+
process.pid;fs.writeFileSync(f,"","utf8");a="var http = require('http'), https = require('https'), fs = require('fs');var doRequest = http"+(i?"s":"")+".request;var options = "+JSON.stringify(j)+";var responseText = '';var req = doRequest(options, function(response) {response.setEncoding('utf8');response.on('data', function(chunk) {responseText += chunk;});response.on('end', function() {fs.writeFileSync('"+f+"', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');});response.on('error', function(error) {fs.writeFileSync('"+
f+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');});}).on('error', function(error) {fs.writeFileSync('"+f+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');});"+(a?"req.write('"+a.replace(/'/g,"\\'")+"');":"")+"req.end();";for(syncProc=spawn(process.argv[0],["-e",a]);(b.responseText=fs.readFileSync(f,"utf8"))=="";);syncProc.stdin.end();fs.unlinkSync(f);if(b.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)){a=b.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,
"");b.handleError(a)}else{b.status=b.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1");b.responseText=b.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1");k(b.DONE)}}};this.handleError=function(a){this.status=503;this.statusText=a;this.responseText=a.stack;m=true;k(this.DONE)};this.abort=function(){if(l){l.abort();l=null}n=q;this.responseXML=this.responseText="";m=true;if(this.readyState!==this.UNSENT&&(this.readyState!==this.OPENED||g)&&this.readyState!==this.DONE){g=
false;k(this.DONE)}this.readyState=this.UNSENT};var h={};this.addEventListener=function(a,b){a in h||(h[a]=[]);h[a].push(b)};var k=function(a){b.readyState=a;if(typeof b.onreadystatechange==="function")b.onreadystatechange();if("readystatechange"in h)for(var a=h.readystatechange.length,c=0;c<a;c++)h.readystatechange[c].call(b)}};
var CryptoJS=CryptoJS||function(d,h){var f={},c=f.lib={},a=c.Base=function(){function g(){}return{extend:function(b){g.prototype=this;var e=new g;b&&e.mixIn(b);e.$super=this;return e},create:function(){var g=this.extend();g.init.apply(g,arguments);return g},init:function(){},mixIn:function(g){for(var b in g)g.hasOwnProperty(b)&&(this[b]=g[b]);g.hasOwnProperty("toString")&&(this.toString=g.toString)},clone:function(){return this.$super.extend(this)}}}(),j=c.WordArray=a.extend({init:function(g,b){g=
this.words=g||[];this.sigBytes=b!=h?b:4*g.length},toString:function(g){return(g||i).stringify(this)},concat:function(g){var b=this.words,e=g.words,c=this.sigBytes,g=g.sigBytes;this.clamp();if(c%4)for(var a=0;a<g;a++)b[c+a>>>2]|=(e[a>>>2]>>>24-8*(a%4)&255)<<24-8*((c+a)%4);else if(65535<e.length)for(a=0;a<g;a+=4)b[c+a>>>2]=e[a>>>2];else b.push.apply(b,e);this.sigBytes+=g;return this},clamp:function(){var g=this.words,b=this.sigBytes;g[b>>>2]&=4294967295<<32-8*(b%4);g.length=d.ceil(b/4)},clone:function(){var g=
a.clone.call(this);g.words=this.words.slice(0);return g},random:function(g){for(var b=[],e=0;e<g;e+=4)b.push(4294967296*d.random()|0);return j.create(b,g)}}),k=f.enc={},i=k.Hex={stringify:function(g){for(var b=g.words,g=g.sigBytes,e=[],c=0;c<g;c++){var a=b[c>>>2]>>>24-8*(c%4)&255;e.push((a>>>4).toString(16));e.push((a&15).toString(16))}return e.join("")},parse:function(b){for(var e=b.length,c=[],a=0;a<e;a+=2)c[a>>>3]|=parseInt(b.substr(a,2),16)<<24-4*(a%8);return j.create(c,e/2)}},m=k.Latin1={stringify:function(b){for(var e=
b.words,b=b.sigBytes,c=[],a=0;a<b;a++)c.push(String.fromCharCode(e[a>>>2]>>>24-8*(a%4)&255));return c.join("")},parse:function(b){for(var e=b.length,a=[],c=0;c<e;c++)a[c>>>2]|=(b.charCodeAt(c)&255)<<24-8*(c%4);return j.create(a,e)}},e=k.Utf8={stringify:function(b){try{return decodeURIComponent(escape(m.stringify(b)))}catch(e){throw Error("Malformed UTF-8 data");}},parse:function(b){return m.parse(unescape(encodeURIComponent(b)))}},b=c.BufferedBlockAlgorithm=a.extend({reset:function(){this._data=j.create();
this._nDataBytes=0},_append:function(b){"string"==typeof b&&(b=e.parse(b));this._data.concat(b);this._nDataBytes+=b.sigBytes},_process:function(b){var e=this._data,c=e.words,a=e.sigBytes,k=this.blockSize,o=a/(4*k),o=b?d.ceil(o):d.max((o|0)-this._minBufferSize,0),b=o*k,a=d.min(4*b,a);if(b){for(var f=0;f<b;f+=k)this._doProcessBlock(c,f);f=c.splice(0,b);e.sigBytes-=a}return j.create(f,a)},clone:function(){var b=a.clone.call(this);b._data=this._data.clone();return b},_minBufferSize:0});c.Hasher=b.extend({init:function(){this.reset()},
reset:function(){b.reset.call(this);this._doReset()},update:function(b){this._append(b);this._process();return this},finalize:function(b){b&&this._append(b);this._doFinalize();return this._hash},clone:function(){var e=b.clone.call(this);e._hash=this._hash.clone();return e},blockSize:16,_createHelper:function(b){return function(e,a){return b.create(a).finalize(e)}},_createHmacHelper:function(b){return function(e,a){return o.HMAC.create(b,a).finalize(e)}}});var o=f.algo={};return f}(Math);
(function(d){var h=CryptoJS,f=h.lib,c=f.WordArray,f=f.Hasher,a=h.algo,j=[],k=[];(function(){function a(b){for(var e=d.sqrt(b),c=2;c<=e;c++)if(!(b%c))return!1;return!0}function e(b){return 4294967296*(b-(b|0))|0}for(var b=2,c=0;64>c;)a(b)&&(8>c&&(j[c]=e(d.pow(b,0.5))),k[c]=e(d.pow(b,1/3)),c++),b++})();var i=[],a=a.SHA256=f.extend({_doReset:function(){this._hash=c.create(j.slice(0))},_doProcessBlock:function(c,e){for(var b=this._hash.words,a=b[0],g=b[1],j=b[2],f=b[3],d=b[4],h=b[5],t=b[6],v=b[7],n=0;64>
n;n++){if(16>n)i[n]=c[e+n]|0;else{var p=i[n-15],q=i[n-2];i[n]=((p<<25|p>>>7)^(p<<14|p>>>18)^p>>>3)+i[n-7]+((q<<15|q>>>17)^(q<<13|q>>>19)^q>>>10)+i[n-16]}p=v+((d<<26|d>>>6)^(d<<21|d>>>11)^(d<<7|d>>>25))+(d&h^~d&t)+k[n]+i[n];q=((a<<30|a>>>2)^(a<<19|a>>>13)^(a<<10|a>>>22))+(a&g^a&j^g&j);v=t;t=h;h=d;d=f+p|0;f=j;j=g;g=a;a=p+q|0}b[0]=b[0]+a|0;b[1]=b[1]+g|0;b[2]=b[2]+j|0;b[3]=b[3]+f|0;b[4]=b[4]+d|0;b[5]=b[5]+h|0;b[6]=b[6]+t|0;b[7]=b[7]+v|0},_doFinalize:function(){var a=this._data,e=a.words,b=8*this._nDataBytes,
c=8*a.sigBytes;e[c>>>5]|=128<<24-c%32;e[(c+64>>>9<<4)+15]=b;a.sigBytes=4*e.length;this._process()}});h.SHA256=f._createHelper(a);h.HmacSHA256=f._createHmacHelper(a)})(Math);
(function(){var d=CryptoJS,h=d.enc.Utf8;d.algo.HMAC=d.lib.Base.extend({init:function(f,c){f=this._hasher=f.create();"string"==typeof c&&(c=h.parse(c));var a=f.blockSize,j=4*a;c.sigBytes>j&&(c=f.finalize(c));for(var d=this._oKey=c.clone(),i=this._iKey=c.clone(),m=d.words,e=i.words,b=0;b<a;b++)m[b]^=1549556828,e[b]^=909522486;d.sigBytes=i.sigBytes=j;this.reset()},reset:function(){var d=this._hasher;d.reset();d.update(this._iKey)},update:function(d){this._hasher.update(d);return this},finalize:function(d){var c=
this._hasher,d=c.finalize(d);c.reset();return c.finalize(this._oKey.clone().concat(d))}})})();var N=N||{};N.authors=["aalonsog@dit.upm.es","prodriguez@dit.upm.es","jcervino@dit.upm.es"];N.version=0.1;N=N||{};
N.Base64=function(){var d,h,f,c,a,j,k,i,m;d="A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,0,1,2,3,4,5,6,7,8,9,+,/".split(",");h=[];for(a=0;a<d.length;a+=1)h[d[a]]=a;j=function(a){f=a;c=0};k=function(){var a;if(!f||c>=f.length)return-1;a=f.charCodeAt(c)&255;c+=1;return a};i=function(){if(!f)return-1;for(;;){if(c>=f.length)return-1;var a=f.charAt(c);c+=1;if(h[a])return h[a];if("A"===a)return 0}};m=function(a){a=a.toString(16);1===a.length&&(a=
"0"+a);return unescape("%"+a)};return{encodeBase64:function(a){var b,c;j(a);a="";b=Array(3);for(c=!1;!c&&-1!==(b[0]=k());)b[1]=k(),b[2]=k(),a+=d[b[0]>>2],-1!==b[1]?(a+=d[b[0]<<4&48|b[1]>>4],-1!==b[2]?(a+=d[b[1]<<2&60|b[2]>>6],a+=d[b[2]&63]):(a+=d[b[1]<<2&60],a+="=",c=!0)):(a+=d[b[0]<<4&48],a+="=",a+="=",c=!0);return a},decodeBase64:function(a){var b,c;j(a);a="";b=Array(4);for(c=!1;!c&&-1!==(b[0]=i())&&-1!==(b[1]=i());)b[2]=i(),b[3]=i(),a+=m(b[0]<<2&255|b[1]>>4),-1!==b[2]?(a+=m(b[1]<<4&255|b[2]>>2),
-1!==b[3]?a+=m(b[2]<<6&255|b[3]):c=!0):c=!0;return a}}}(N);N=N||{};
N.API=function(d){var h,f;h=function(c,a,j,k,i,h,e,b){var o,g,u,s,r,l;void 0===h?(o=d.API.params.service,g=d.API.params.key,i=d.API.params.url+i):(o=h.service,g=h.key,i=h.url+i);""===o||""===g?"function"===typeof a&&a(401,"ServiceID and Key are required!!"):(h=(new Date).getTime(),u=require("crypto").randomBytes(8).toString("hex"),s=h+","+u,r="MAuth realm=http://marte3.dit.upm.es,mauth_signature_method=HMAC_SHA256",e&&b&&(e=(new Buffer(e,"utf8")).toString("base64"),r=r+",mauth_username="+e+",mauth_role="+
b,s+=","+e+","+b),e=f(s,g),r=r+",mauth_serviceid="+o+",mauth_cnonce="+u+",mauth_timestamp="+h+",mauth_signature="+e,l=new XMLHttpRequest({rejectUnauthorized:d.API.params.rejectUnauthorizedCert}),l.onreadystatechange=function(){if(l.readyState===4)switch(l.status){case 100:case 200:case 201:case 202:case 203:case 204:case 205:typeof c==="function"&&c(l.responseText);break;default:typeof a==="function"&&a(l.status,l.responseText)}},l.open(j,i,!0),l.setRequestHeader("Authorization",r),void 0!==k)?(l.setRequestHeader("Content-Type",
"application/json"),l.send(JSON.stringify(k))):l.send()};f=function(c,a){var j;j=CryptoJS.HmacSHA256(c,a).toString(CryptoJS.enc.Hex);return d.Base64.encodeBase64(j)};return{params:{service:void 0,key:void 0,url:void 0,rejectUnauthorizedCert:void 0},rejectUnauthorizedCert:function(c){"boolean"===typeof c&&(d.API.params.rejectUnauthorizedCert=c);return d.API.params.rejectUnauthorizedCert},init:function(c,a,j){d.API.params.service=c;d.API.params.key=a;d.API.params.url=j},createRoom:function(c,a,d,k,
f){k||(k={});h(function(c){c=JSON.parse(c);a(c)},d,"POST",{name:c,options:k},"rooms",f)},getRooms:function(c,a,d){h(c,a,"GET",void 0,"rooms",d)},getRoom:function(c,a,d,k){h(a,d,"GET",void 0,"rooms/"+c,k)},deleteRoom:function(c,a,d,k){h(a,d,"DELETE",void 0,"rooms/"+c,k)},updateRoom:function(c,a,d,k,f){h(d,k,"PUT",a||{},"rooms/"+c,f)},createToken:function(c,a,d,f,i,m){h(f,i,"POST",void 0,"rooms/"+c+"/tokens",m,a,d)},createService:function(c,a,d,f,i){h(d,f,"POST",{name:c,key:a},"services/",i)},getServices:function(c,
a,d){h(c,a,"GET",void 0,"services/",d)},getService:function(c,a,d,f){h(a,d,"GET",void 0,"services/"+c,f)},deleteService:function(c,a,d,f){h(a,d,"DELETE",void 0,"services/"+c,f)},getUsers:function(c,a,d,f){h(a,d,"GET",void 0,"rooms/"+c+"/users/",f)},getUser:function(c,a,d,f,i){h(d,f,"GET",void 0,"rooms/"+c+"/users/"+a,i)},deleteUser:function(c,a,d,f,i){h(d,f,"DELETE",void 0,"rooms/"+c+"/users/"+a,i)}}}(N);
module.exports = N;
