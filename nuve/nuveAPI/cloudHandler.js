var rpc=require("./rpc/rpc"),config=require("./../../etc/woogeen_config"),logger=require("./logger").logger,nuveKey=require("./mdb/dataBase").nuveKey,log=logger.getLogger("CloudHandler"),ec2,INTERVAL_TIME_EC_READY=100,INTERVAL_TIME_CHECK_KA=1e3,MAX_KA_COUNT=10,erizoNodes={},rooms={},ecQueue=[],eaTop=void 0,idIndex=0,recalculateEcPriority=function(){"use strict";var e,o=[],r=0,i=0;for(e in erizoNodes)erizoNodes.hasOwnProperty(e)&&2===erizoNodes[e].state&&"reception"===erizoNodes[e].purpose&&(o.push(e),r+=1);for(e in erizoNodes)erizoNodes.hasOwnProperty(e)&&1===erizoNodes[e].state&&"reception"===erizoNodes[e].purpose&&(o.push(e),i+=1);ecQueue=o,(0===ecQueue.length||0===r&&2>i)&&log.info("[CLOUD HANDLER]: Warning! No erizoController is available.")},recalculateEaPriority=function(){eaTop=void 0;for(ecea in erizoNodes)erizoNodes.hasOwnProperty(ecea)&&"general-use"===erizoNodes[ecea].purpose&&(void 0===eaTop||erizoNodes[ecea].load<erizoNodes[eaTop].load)&&(eaTop=ecea);void 0===eaTop&&log.info("[CLOUD HANDLER]: Warning! No erizoAgent is available.")},checkKA=function(){"use strict";var e,o;for(e in erizoNodes)if(erizoNodes.hasOwnProperty(e)&&(erizoNodes[e].keepAlive+=1,erizoNodes[e].keepAlive>MAX_KA_COUNT)){log.info("reception"===erizoNodes[e].purpose?"ErizoController":"ErizoAgent",e," in ",erizoNodes[e].ip,"does not respond. Deleting it."),delete erizoNodes[e];for(o in rooms)rooms.hasOwnProperty(o)&&(rooms[o].ec===e&&(rooms[o].ec=void 0),rooms[o].ea===e&&(rooms[o].ea=void 0),void 0===rooms[o].ec&&void 0===rooms[o].ea&&delete rooms[o]);recalculateEcPriority(),recalculateEaPriority()}},checkKAInterval=setInterval(checkKA,INTERVAL_TIME_CHECK_KA);exports.addNewErizoController=function(e,o){"use strict";""===e.cloudProvider?addNewPrivateErizoController(e.ip,e.hostname,e.port,e.ssl,o):"amazon"===e.cloudProvider&&addNewAmazonErizoController(e.ip,e.hostname,e.port,e.ssl,o)};var addNewAmazonErizoController=function(e,o){var r;if(void 0===ec2){var i={version:"2012-12-01"};""!==config.cloudProvider.host&&(i.host=config.cloudProvider.host),ec2=require("aws-lib").createEC2Client(config.cloudProvider.accessKey,config.cloudProvider.secretAccessKey,i)}log.info("private ip ",e),ec2.call("DescribeInstances",{"Filter.1.Name":"private-ip-address","Filter.1.Value":e},function(e,i){e?(log.info("Error: ",e),o("error")):i&&(r=i.reservationSet.item.instancesSet.item.ipAddress,log.info("public IP: ",r),addNewPrivateErizoController(r,hostname,port,ssl,o))})},addNewPrivateErizoController=function(e,o,r,i,t){"use strict";idIndex+=1;var s=idIndex,c="erizoController_"+s;erizoNodes[s]={ip:e,purpose:"reception",rpcID:c,state:2,keepAlive:0,hostname:o,port:r,ssl:i},log.info("New erizocontroller (",s,") in: ",erizoNodes[s].ip),recalculateEcPriority(),t({id:s,publicIP:e,hostname:o,port:r,ssl:i})};exports.addNewErizoAgent=function(e,o){"use strict";idIndex+=1;var r=idIndex,i="ErizoAgent_"+r;erizoNodes[r]={id:r,purpose:"general-use",ip:e.ip,rpcID:i,state:2,load:0,keepAlive:0},log.info("New erizoAgent (",r,") in: ",erizoNodes[r].ip),recalculateEaPriority(),o({id:r,privateIP:e.ip})},exports.keepAlive=function(e,o){"use strict";var r;void 0===erizoNodes[e]?(r="whoareyou",log.info("I received a keepAlive mess from a removed erizoController")):(erizoNodes[e].keepAlive=0,r="ok"),o(r)},exports.setInfo=function(e){"use strict";log.info("Received info ",e,".Recalculating erizoNodes priority"),erizoNodes[e.id].state=e.state,recalculateEcPriority()},exports.killMe=function(e){"use strict";log.info("[CLOUD HANDLER]: ErizoController in host ",e,"does not respond.")},exports.getErizoControllerForRoom=function(e,o){"use strict";if(void 0!==rooms[e]&&void 0!==rooms[e].ec)return void o(erizoNodes[rooms[e].ec]);var r,i=setInterval(function(){r=ecQueue[0],void 0!==r&&(void 0===rooms[e]&&(rooms[e]={}),rooms[e].ec=r,o(erizoNodes[r]),recalculateEcPriority(),clearInterval(i))},INTERVAL_TIME_EC_READY)},exports.allocErizoAgent=function(e,o){"use strict";var r=e;if(void 0!==rooms[r]&&void 0!==rooms[r].ea)return void o(erizoNodes[rooms[r].ea]);var i,t=setInterval(function(){i=eaTop,void 0!==i&&(void 0===rooms[r]&&(rooms[r]={}),rooms[r].ea=i,o(erizoNodes[i]),erizoNodes[i].load+=1,recalculateEaPriority(),clearInterval(t))},INTERVAL_TIME_EC_READY)},exports.freeErizoAgent=function(e,o){"use strict";var r=e;void 0!==rooms[r]&&(erizoNodes[r].load-=1,recalculateEaPriority())},exports.getUsersInRoom=function(e,o){"use strict";if(void 0===rooms[e]||void 0===rooms[e].ec)return void o("error");var r=erizoNodes[rooms[e].ec].rpcID;rpc.callRpc(r,"getUsersInRoom",[e],{callback:function(e){"timeout"===e&&(e="?"),o(e)}})},exports.deleteRoom=function(e,o){"use strict";if(void 0===rooms[e]||void 0===rooms[e].ec)return void o("Success");var r=erizoNodes[rooms[e].ec].rpcID;rpc.callRpc(r,"deleteRoom",[e],{callback:function(e){o(e)}})},exports.deleteUser=function(e,o,r){"use strict";if(void 0===rooms[o]||void 0===rooms[o].ec)return void r("Success");var i=erizoNodes[rooms[o].ec].rpcID;rpc.callRpc(i,"deleteUser",[{user:e,roomId:o}],{callback:function(e){r(e)}})},exports.getEcQueue=function(e){"use strict";return arguments.length>0?erizoNodes[e]:ecQueue.map(function(e){return erizoNodes[e]})},exports.getEcConfig=function(e,o){"use strict";rpc.callRpc(e,"getConfig",[],{callback:function(e){o(e)}})},exports.getHostedRooms=function(){"use strict";return Object.keys(rooms).map(function(e){return{id:e,ec:rooms[e].ec,ea:rooms[e].ea}})},exports.reschedule=function(e){"use strict";delete rooms[e]},exports.getKey=function(e){"use strict";return erizoNodes[e]?nuveKey:"error"};