"use strict";var express=require("express"),bodyParser=require("body-parser"),config=require("./../../etc/woogeen_config"),rpc=require("./rpc/rpc"),logger=require("./logger").logger,log=logger.getLogger("Nuve"),app=express();rpc.connect();var nuveAuthenticator=require("./auth/nuveAuthenticator"),roomsResource=require("./resource/roomsResource"),roomResource=require("./resource/roomResource"),tokensResource=require("./resource/tokensResource"),servicesResource=require("./resource/servicesResource"),serviceResource=require("./resource/serviceResource"),usersResource=require("./resource/usersResource"),userResource=require("./resource/userResource"),clusterResource=require("./resource/clusterResource");if(app.use("/console",express["static"](__dirname+"/public")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.set("view options",{layout:!1}),app.use(function(e,r,o){r.header("Access-Control-Allow-Origin","*"),r.header("Access-Control-Allow-Methods","POST, GET, OPTIONS, DELETE"),r.header("Access-Control-Allow-Headers","origin, authorization, content-type"),o()}),app.options("*",function(e,r){r.send(200)}),app.get("*",nuveAuthenticator.authenticate),app.post("*",nuveAuthenticator.authenticate),app["delete"]("*",nuveAuthenticator.authenticate),app.put("*",nuveAuthenticator.authenticate),app.post("/rooms",roomsResource.createRoom),app.get("/rooms",roomsResource.represent),app.get("/rooms/:room",roomResource.represent),app["delete"]("/rooms/:room",roomResource.deleteRoom),app.put("/rooms/:room",roomResource.updateRoom),app.post("/rooms/:room/tokens",tokensResource.create),app.post("/services",servicesResource.create),app.get("/services",servicesResource.represent),app.get("/services/:service",serviceResource.represent),app["delete"]("/services/:service",serviceResource.deleteService),app.get("/rooms/:room/users",usersResource.getList),app.get("/rooms/:room/users/:user",userResource.getUser),app["delete"]("/rooms/:room/users/:user",userResource.deleteUser),app.get("/cluster/nodes",clusterResource.getNodes),app.get("/cluster/nodes/:node",clusterResource.getNode),app.get("/cluster/rooms",clusterResource.getRooms),app.get("/cluster/nodes/:node/config",clusterResource.getNodeConfig),config.nuve.ssl===!0){var cipher=require("../../common/cipher");cipher.unlock(cipher.k,"../../cert/.woogeen.keystore",function(e,r){if(!e)try{require("https").createServer({pfx:require("fs").readFileSync(config.nuve.keystorePath),passphrase:r.nuve},app).listen(3e3)}catch(o){e=o}return e?(log.warn("Failed to setup secured server:",e),process.exit()):void 0})}else app.listen(3e3);